---
import Acordeon from "../constructor/Acordeon.astro";
import AsideTravel from "../ui/AsideTravel.astro";
import { Fragment } from "astro/jsx-runtime";
const tour = {
  title: "Africa – Amazing African Safari",
  duration: "5 Hours",
  maxGuests: 12,
  location: "1421 San Pedro St, Los Angeles, CA",
  price: 130,
  oldPrice: 16000,
  rating: 5,
  reviews: 1,
  featured: true,
  images: ["/images/gato.jpg", "/images/gato.jpg", "/images/gato.jpg"],
};
// WeTravelWidget.astro

const {
  color = "1666F4",
  text = "Book Now",
  showReviews = true,
  env = "https://www.wetravel.com",

  data,
  lenguaje,
} = Astro.props;
---

<section class="bg-white py-6 relative px-4 mx-auto">
  <div
    class="absolute -top-12 md:left-20 px-2 mb-8 flex justify-center gap-2 rounded-t-xl bg-white pt-2 min-w-40 max-w-100 w-auto"
  >
    <button
      id="tab-info"
      class="tab-btn px-6 bg-white py-3 font-semibold rounded-lg hover:bg-azul-travel hover:text-white duration-300 active:scale-95 transition text-black"
      data-tab="info"
    >
      {lenguaje.infoBotonDescripcion}
    </button>
    {
      data.itinerary && data.itinerary.length > 0 && (
        <button
          id="tab-plan"
          class="tab-btn px-6 bg-white py-3 font-semibold rounded-lg transition text-black hover:bg-azul-travel active:scale-95 hover:text-white duration-300"
          data-tab="plan"
        >
          {lenguaje.infoBotonPlanificacion}
        </button>
      )
    }
  </div>

  <div class="flex flex-col lg:flex-row justify-between gap-6">
    <section id="tab-content-info" class="block w-full">
      <div class="flex flex-col lg:flex-row w-full">
        <div
          class="flex items-center gap-2 md:gap-4 text-sm text-gray-500 mb-4 flex-wrap"
        >
          {
            data.recomendado ? (
              <span class="w-auto z-10 bg-azul-travel text-white text-xs font-semibold px-3 py-1 rounded mb-2">
                {lenguaje.infoRecomendado}
              </span>
            ) : (
              <span />
            )
          }
          <h1 class="text-3xl w-full font-bold text-gray-900">
            {data.title}
          </h1>
          <p class="flex items-center gap-2">
            {data.duration}
            {lenguaje.infoDias}
          </p>
          <p class="flex items-center gap-2">
            {lenguaje.infoHuespedes}: {data.groupSize}
          </p>
          <p class="flex items-center gap-2">
            {data.location}
          </p>
        </div>
        <div
          class="flex mb-4 lg:flex-col-reverse justify-between lg:justify-center gap-4 lg:gap-0 items-center text-center w-full"
        >
          <p
            class="text-yellow-500 flex lg:flex-col gap-4 justify-center items-center text-xl"
          >
            {"★".repeat(data.rating)}{"☆".repeat(5 - data.rating)}
            <span class="text-gray-500 text-xs"
              >({data.reseñas} {lenguaje.infoReseñas})</span
            >
          </p>
          <!--  <p class="text-azul-travel font-semibold text-lg lg:text-2xl">
            {data.packages[0].price}
          </p> -->
        </div>
      </div>
      <div class="flex flex-col lg:flex-row gap-4 justify-around">
        {
          !data.images?.[1] && (
            <img
              src={data.images[0].link}
              alt="Tour image"
              class="w-full  h-52 lg:h-[60svh] max-h-100  object-cover rounded-xl"

            />
          )
        }
        {
          data.images?.[1] && (
            <img
              src={data.images[1].link}
              alt="Tour image"
              class="w-full lg:w-3/7 h-52 lg:h-[60svh] max-h-100 lg:max-w-sm xl:max-w-3/7 object-cover rounded-xl"
            />
          )
        }

        {
          data.images?.[2] && (
            <img
              src={data.images[2].link}
              alt="Tour image"
              class="w-full lg:w-2/7 h-52 lg:h-[60svh] max-h-100 lg:max-w-xs xl:max-w-2/7 object-cover rounded-xl"
            />
          )
        }

        {
          data.images?.[3] && (
            <img
              src={data.images[3].link}
              alt="Tour image"
              class="w-full lg:w-2/7 h-52 lg:h-[60svh] max-h-100 lg:max-w-xs xl:max-w-2/7 object-cover rounded-xl"
            />
          )
        }
      </div>
      <div class="flex flex-col lg:flex-row gap-4 flex-1 w-full">
        <section class="py-12 max-w-2xl px-4 bg-white mx-auto space-y-10">
          <h2 class="text-lg font-semibold mb-2">
            {lenguaje.infoDescripcion}:
          </h2>
          <p class="py-4">
            {data.description}
          </p>
          <!-- 
          {
            Array.isArray(data?.highlights) && data.highlights.length > 0 && (
              <ul class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-4">
                {data.highlights.map((text) => (
                  <li class="text-sm font-semibold">
                    <span class="text-green-700">✔</span> {text}
                  </li>
                ))}
              </ul>
            )
          }
            -->

          {
            Array.isArray(data?.includes) && data.includes.length > 0 && (
              <div>
                <h2 class="text-lg font-semibold  mb-2">
                  {lenguaje.infoIncluye}:
                </h2>
                <ul class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {data.includes.map((item) => (
                    <li class="text-sm  ">
                      <span class="text-green-700">✔</span> {item}
                    </li>
                  ))}
                </ul>
              </div>
            )
          }

          {
            Array.isArray(data?.excludes) && data.excludes.length > 0 && (
              <div>
                <h2 class="text-lg font-semibold  mb-2">
                  {lenguaje.infoNoIncluye}:
                </h2>
                <ul class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {data.excludes.map((item) => (
                    <li class="text-sm ">
                      <span class="text-red-600">x</span> {item}
                    </li>
                  ))}
                </ul>
              </div>
            )
          }
          <h2 class="text-lg font-semibold mb-2">{lenguaje.infoPaquetes}</h2>
          <div>
            <div
              id="wetravel_package_listing"
              data-uid={data.uid}
              data-uuid={data.uuid}
              data-color={color}
              data-text={lenguaje.infoReserva}
              data-showreviews={showReviews}
              data-env={env}
              class="w-full h-full flex justify-center scroll-mt-40 my-8"
            >
              <!-- El iframe se insertará aquí -->
            </div>

            {
              data.addOns && data.addOns.length > 0 && (
                <section aria-labelledby="add-ons-heading" class="mt-4">
                  <h2
                    id="add-ons-heading"
                    class="text-xl font-semibold text-black mb-4"
                  >
                    {lenguaje.infoComplementos}
                  </h2>

                  <ul role="list">
                    {data.addOns.map((addon) => (
                      <li class="border-b border-gray-200 py-4">
                        <h3 class="flex justify-between text-lg font-semibold text-gray-800">
                          {addon.name}
                          <span class="text-sm font-medium text-azul-travel mt-2">
                            {addon.price}
                          </span>
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                          {addon.description}
                        </p>
                      </li>
                    ))}
                  </ul>
                </section>
              )
            }
          </div>
        </section>
        <AsideTravel lenguaje={lenguaje} data={data} />
      </div>
    </section>
    <section
      id="tab-content-plan"
      class="text-gray-700 flex flex-col lg:flex-row hidden w-full"
    >
      <Acordeon data={data} lenguaje={lenguaje} />
      <AsideTravel lenguaje={lenguaje} data={data} />
    </section>
  </div>
<script type="text/javascript"
  src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script type="text/javascript">
  emailjs.init('E6459n1o-mTYoqA3b')
</script>
<script is:inline>
// Selecciona todos los formularios con clase "formAside"
document.querySelectorAll('.formAside').forEach(form => {
  // Selecciona el botón dentro de cada formulario
  const btn = form.querySelector('.btn-submit');

  form.addEventListener('submit', function(event) {
    event.preventDefault();

    btn.value = 'Sending...';

    const serviceID = 'service_3iya7ah';
    const templateID = 'template_zbmrdgd';

    emailjs.sendForm(serviceID, templateID, this)
      .then(() => {
        btn.value = 'Send Email';
        alert('Sent!');
      }, (err) => {
        btn.value = 'Send Email';
        alert(JSON.stringify(err));
      });
  });
});

</script>



  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(".tab-btn");
      const contents = {
        info: document.getElementById("tab-content-info"),
        plan: document.getElementById("tab-content-plan"),
      };

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          // reset all
          tabs.forEach((t) => {
            t.classList.remove("text-[-azul-travel]", "border-[-azul-travel]");
            t.classList.add("text-gray-500", "border-transparent");
          });
          Object.values(contents).forEach((c) => c.classList.add("hidden"));

          // activate clicked
          const selected = tab.dataset.tab;
          tab.classList.remove("text-gray-500", "border-transparent");
          tab.classList.add("text-[-azul-travel]", "border-[-azul-travel]");
          contents[selected].classList.remove("hidden");
        });
      });

      // default active tab
      document
        .getElementById("tab-info")
        .classList.add("text-[-azul-travel]", "border-[-azul-travel]");
    });
  </script>
</section>
<script>
  // Inicializar el widget cuando el DOM esté listo
  function initWeTravelWidget() {
    const container = document.getElementById("wetravel_package_listing");
    if (!container) return;

    const { uid, uuid, color, text, showreviews, env } = container.dataset;

    const iframeSrc = `${env}/packages_embed?uuid=${uuid}&btn_color=${color}&btn_name=${encodeURIComponent(text)}&show_reviews=${showreviews}&env=${env}`;

    // Crear iframe principal
    const iframe = document.createElement("iframe");
    iframe.setAttribute("frameborder", "0");
    iframe.src = iframeSrc;
    iframe.className = "flex w-full h-full justify-center min-h-130";

    // Reemplazar el contenido del container con el iframe
    container.innerHTML = "";
    container.appendChild(iframe);

    // Listener para el checkout
    window.addEventListener("message", (event) => {
      if (!event.data) return;

      // Abrir checkout
      if (
        typeof event.data === "string" &&
        event.data.includes("WTRVL_checkout")
      ) {
        const [, checkoutUrl] = event.data.split("WTRVL_checkout");
        if (checkoutUrl) {
          openCheckout(checkoutUrl);
        }
      }

      // Cerrar checkout
      if (event.data === "wtrvlCheckoutClosed") {
        closeCheckout();
      }
    });

    // Enviar analytics
    sendAnalytics("load", uid, env);
  }

  // Abrir modal de checkout
  function openCheckout(url) {
    if (document.querySelector(".wtrvl-checkout-iframe")) return;

    const checkoutIframe = document.createElement("iframe");
    checkoutIframe.className =
      "wtrvl-checkout-iframe fixed top-0 left-0 w-screen h-screen border-0";
    checkoutIframe.style.zIndex = "999999";
    checkoutIframe.src = url;

    document.body.classList.add("overflow-hidden");
    document.body.appendChild(checkoutIframe);

    setTimeout(() => {
      checkoutIframe.contentWindow?.postMessage("packageWidget", "*");
    }, 3000);
  }

  // Cerrar modal de checkout
  function closeCheckout() {
    const checkoutIframe = document.querySelector(".wtrvl-checkout-iframe");
    if (checkoutIframe) {
      checkoutIframe.remove();
      document.body.classList.remove("overflow-hidden");
    }
  }

  // Enviar analytics a WeTravel
  function sendAnalytics(actionType, uid, env) {
    const data = {
      version: "v0.3",
      user_id: uid,
      embed_type: "packages",
      action_type: actionType,
      url: window.location.href,
    };

    fetch("https://t.wetravel.com/widgets", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    }).catch(() => {}); // Ignorar errores de analytics
  }

  // Iniciar cuando el DOM esté listo
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initWeTravelWidget);
  } else {
    initWeTravelWidget();
  }
</script>

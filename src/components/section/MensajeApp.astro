---
import WhatsappPop from "../ui/WhatsappPop.astro";
import MessengerPop from "../ui/MessengerPop.astro";
import data from "../../data/accessibleTravel.json";
---

<!-- Botón principal para abrir -->
<button
  id="contact-open-btn"
  title="Abrir panel de contacto"
  aria-label="Abrir panel de contacto"
  class="fixed bottom-5 right-1 md:right-5 z-50 px-2 py-2 rounded-full bg-amber-400 hover:bg-amber-500 active:scale-95 hover:scale-105 duration-300 flex items-center justify-center shadow-lg transition-all"
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="h-10 w-10"
  >
    <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path>
    <path d="M8 12h.01"></path>
    <path d="M12 12h.01"></path>
    <path d="M16 12h.01"></path>
  </svg>
</button>

<!-- Panel de contacto -->
<div
  id="contact-panel"
  class="fixed flex flex-col space-y-1 duration-300 translate-y-[200%] opacity-0 z-50 bottom-5 right-1 md:right-5 pointer-events-none"
  role="dialog"
  aria-labelledby="contact-panel-title"
  aria-hidden="true"
>
  <!-- Botón cerrar -->
  <button
    id="contact-close-btn"
    class="ml-auto mr-2 active:scale-95 hover:scale-105 transition-transform mb-1"
    aria-label="Cerrar panel de contacto"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="2.5"
      stroke="currentColor"
      class="w-10 h-10 text-amber-400 drop-shadow-lg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>

  <!-- Título invisible para accesibilidad -->
  <h2 id="contact-panel-title" class="sr-only">Panel de contacto</h2>

  <!-- Contenido del panel -->
  <div class="flex flex-col space-y-2 ">
    <!-- WhatsApp 1 con label -->
    <div class="flex items-center justify-end gap-2">
      <!-- Label visible siempre a la izquierda -->
      <div class="bg-gray-900 text-white text-xs md:text-sm px-3 py-2 rounded-lg shadow-lg whitespace-nowrap">
        <span class="font-medium">{data.whatsapp1.tooltipText || "WhatsApp"}</span>
      </div>
      <!-- Botón de WhatsApp -->
      <WhatsappPop data={data.whatsapp1} />
    </div>

    <!-- WhatsApp 2 con label -->
    <div class="flex items-center justify-end gap-2">
      <!-- Label visible siempre a la izquierda -->
      <div class="bg-gray-900 text-white text-xs md:text-sm px-3 py-2 rounded-lg shadow-lg whitespace-nowrap">
        <span class="font-medium">{data.whatsapp2.tooltipText || "WhatsApp"}</span>
      </div>
      <!-- Botón de WhatsApp -->
      <WhatsappPop data={data.whatsapp2} />
    </div>

    <!-- Messenger con label -->
    <div class="flex items-center justify-end gap-2">
      <!-- Label visible siempre a la izquierda -->
      <div class="bg-gray-900 text-white text-xs md:text-sm px-3 py-2 rounded-lg shadow-lg whitespace-nowrap">
        <span class="font-medium">{data.Messenger.tooltipText || "Messenger"}</span>
      </div>
      <!-- Botón de Messenger -->
      <MessengerPop data={data.Messenger} />
    </div>
  </div>
</div>

<script>
  // ========================================
  // CONFIGURACIÓN
  // ========================================
  const CONFIG = {
    classes: {
      hidden: ['translate-y-[200%]', 'opacity-0', 'pointer-events-none'],
      visible: ['translate-y-0', 'opacity-100', 'pointer-events-auto'],
    },
    animationDuration: 300,
  } as const;

  // ========================================
  // ESTADO
  // ========================================
  let isOpen = false;

  // ========================================
  // ELEMENTOS DEL DOM
  // ========================================
  const elements = {
    openBtn: document.getElementById('contact-open-btn') as HTMLButtonElement | null,
    closeBtn: document.getElementById('contact-close-btn') as HTMLButtonElement | null,
    panel: document.getElementById('contact-panel') as HTMLDivElement | null,
  };

  // ========================================
  // VALIDACIÓN
  // ========================================
  const validateElements = (): boolean => {
    const { openBtn, closeBtn, panel } = elements;
    
    if (!openBtn || !closeBtn || !panel) {
      console.error('Contact Panel: Faltan elementos necesarios');
      return false;
    }
    return true;
  };

  // ========================================
  // FUNCIONES DE CONTROL
  // ========================================
  const toggleClasses = (element: HTMLElement, classes: string[], add: boolean): void => {
    const method = add ? 'add' : 'remove';
    classes.forEach(cls => element.classList[method](...cls.split(' ')));
  };

  const openPanel = (): void => {
    if (isOpen || !elements.openBtn || !elements.panel) return;

    isOpen = true;
    const { openBtn, closeBtn, panel } = elements;

    // Ocultar botón de apertura
    toggleClasses(openBtn, CONFIG.classes.hidden, true);
    openBtn.setAttribute('aria-hidden', 'true');
    openBtn.disabled = true;

    // Mostrar panel
    requestAnimationFrame(() => {
      toggleClasses(panel, CONFIG.classes.hidden, false);
      panel.setAttribute('aria-hidden', 'false');
    });

    // Focus en botón de cerrar
    setTimeout(() => closeBtn?.focus(), CONFIG.animationDuration);
  };

  const closePanel = (): void => {
    if (!isOpen || !elements.openBtn || !elements.panel) return;

    isOpen = false;
    const { openBtn, panel } = elements;

    // Ocultar panel
    toggleClasses(panel, CONFIG.classes.hidden, true);
    panel.setAttribute('aria-hidden', 'true');

    // Mostrar botón de apertura
    setTimeout(() => {
      toggleClasses(openBtn, CONFIG.classes.hidden, false);
      openBtn.setAttribute('aria-hidden', 'false');
      openBtn.disabled = false;
      openBtn.focus();
    }, CONFIG.animationDuration);
  };

  // ========================================
  // MANEJADORES DE EVENTOS
  // ========================================
  const handleKeydown = (e: KeyboardEvent): void => {
    if (e.key === 'Escape' && isOpen) closePanel();
  };

  const handleClickOutside = (e: MouseEvent): void => {
    if (!isOpen || !elements.panel) return;

    const target = e.target as HTMLElement;
    const { openBtn, panel } = elements;

    if (!panel.contains(target) && target !== openBtn && !openBtn?.contains(target)) {
      closePanel();
    }
  };

  // ========================================
  // LIMPIEZA
  // ========================================
  const cleanup = (): void => {
    document.removeEventListener('keydown', handleKeydown);
    document.removeEventListener('click', handleClickOutside);
  };

  // ========================================
  // INICIALIZACIÓN
  // ========================================
  const init = (): void => {
    if (!validateElements()) return;

    const { openBtn, closeBtn } = elements;

    // Event listeners
    openBtn?.addEventListener('click', openPanel);
    closeBtn?.addEventListener('click', closePanel);
    document.addEventListener('keydown', handleKeydown);

    setTimeout(() => {
      document.addEventListener('click', handleClickOutside);
    }, 100);

    window.addEventListener('beforeunload', cleanup);

    console.log('Contact Panel: Inicializado correctamente');
  };

  // Inicializar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  #contact-open-btn,
  #contact-panel {
    transition-property: transform, opacity;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 300ms;
  }

  #contact-open-btn:not([aria-hidden="true"]) {
    animation: bounce-in 0.5s ease-out;
  }

  @keyframes bounce-in {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  #contact-open-btn:hover {
    box-shadow: 0 10px 25px rgba(251, 191, 36, 0.5);
  }

  @media (prefers-reduced-motion: reduce) {
    #contact-open-btn,
    #contact-panel {
      transition: none;
      animation: none;
    }
  }

  @media (max-width: 768px) {
    #contact-panel {
      right: 0.25rem;
      max-width: calc(100vw - 0.5rem);
    }
  }
</style>